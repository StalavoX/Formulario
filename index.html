<!doctype html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>REPORTE DE MANTENIMIENTO DE EQUIPOS</title>
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#1f6feb; --border:#e5e7eb;
Â  Â  Â  --radius:10px; --maxw:920px;
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#111;margin:0;padding:18px;display:flex;justify-content:center}
Â  Â  .container{width:100%;max-width:var(--maxw);}
Â  Â  .header{display:flex;gap:14px;align-items:center;padding:16px;background:linear-gradient(90deg,#fff,#fafafa);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:14px}
Â  Â  .logo{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#eef2ff,#dbeafe);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;font-size:20px;box-shadow:0 2px 6px rgba(31,111,235,0.06)}
Â  Â  h1{font-size:18px;margin:0;color:#0f172a}
Â  Â  .sub{font-size:13px;color:var(--muted)}
Â  Â  form{display:block}
Â  Â  .card{background:var(--card);padding:12px 14px;border-radius:10px;margin-bottom:12px;border:1px solid var(--border);box-shadow:0 1px 2px rgba(16,24,40,0.02)}
Â  Â  label{display:block;margin-bottom:6px;font-weight:600;color:#0f172a;font-size:14px}
Â  Â  input[type="text"], input[type="date"], input[type="tel"], select, textarea, input[type="number"], input[type="email"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:transparent;box-sizing:border-box;font-size:14px}
Â  Â  .row{display:flex;gap:10px}
Â  Â  .col{flex:1;min-width:0}
Â  Â  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
Â  Â  button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
Â  Â  .btn-primary{background:var(--accent);color:white;box-shadow:0 6px 18px rgba(31,111,235,0.12)}
Â  Â  .btn-secondary{background:#eef6ff;color:var(--accent);border:1px solid rgba(31,111,235,0.08)}
Â  Â  .small{font-size:13px;color:var(--muted)}
Â  Â  .checkboxes{display:flex;flex-wrap:wrap;gap:8px}
Â  Â  .chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#fbfdff;border:1px solid var(--border);font-size:13px}
Â  Â  .team{border:1px dashed var(--border);padding:10px;border-radius:10px;margin-bottom:10px;background:#ffffff}
Â  Â  .tasks{display:flex;flex-direction:column;gap:6px;margin-top:8px}
Â  Â  .measure{display:flex;flex-direction:column;gap:6px;margin-top:8px}
Â  Â  canvas{border:1px solid var(--border);border-radius:8px;background:white;touch-action:none;width:100%;height:140px}
Â  Â  .muted{color:var(--muted);font-size:13px}
Â  Â  .legend{font-size:13px;color:var(--muted);margin-bottom:8px}
Â  Â  @media (max-width:640px){ .row{flex-direction:column} .logo{width:56px;height:56px} }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <div class="header">
Â  Â  Â  <div class="logo" aria-hidden="true">
Â  Â  Â  Â  <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" fill="#1f6feb"/>
Â  Â  Â  Â  Â  <path d="M19.4 13.5a7.9 7.9 0 0 0 0-3l2.1-1.6-2-3.4-2.6 1a8 8 0 0 0-2.6-1.5L13 1H11l-1.3 2.1a8 8 0 0 0-2.6 1.5l-2.6-1-2 3.4L4.6 10a7.9 7.9 0 0 0 0 3L2.5 15.6l2 3.4 2.6-1a8 8 0 0 0 2.6 1.5L11 23h2l1.3-2.1a8 8 0 0 0 2.6-1.5l2.6 1 2-3.4L19.4 13.5z" fill="#cfe2ff" opacity="0.9"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <h1>REPORTE DE MANTENIMIENTO DE EQUIPOS</h1>
Â  Â  Â  Â  <div class="sub">Formulario para tÃ©cnicos â€” EnvÃ­o automÃ¡tico y PDF al cliente</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <form id="form" autocomplete="off">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Fecha del mantenimiento</label>
Â  Â  Â  Â  <input type="date" name="fecha" required>

Â  Â  Â  Â  <label style="margin-top:10px">Cliente</label>
Â  Â  Â  Â  <input type="text" name="cliente" required>

Â  Â  Â  Â  <div class="row" style="margin-top:10px">
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>Sede</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="sede" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>DirecciÃ³n</label>
Â  Â  Â  Â  Â  Â  <input type="text" name="direccion">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="margin-top:10px">TelÃ©fono</label>
Â  Â  Â  Â  <input type="tel" name="telefono" placeholder="+57 300 0000000">
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Elementos de ProtecciÃ³n Personal (marque los utilizados)</label>
Â  Â  Â  Â  <div class="checkboxes" id="epp">
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Guantes"> Guantes</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Gafas"> Gafas</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Casco"> Casco</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Botas"> Botas</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Tapaoidos"> TapaoÃ­dos</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="checkbox" name="epp" value="Tapabocas"> Tapabocas</label>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="margin-top:10px">Se verificÃ³ instructivo para lÃ¡mparas UV</label>
Â  Â  Â  Â  <div class="row" style="margin-top:6px">
Â  Â  Â  Â  Â  <label class="chip"><input type="radio" name="uv" value="Aplica" required> Aplica</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="radio" name="uv" value="No aplica"> No aplica</label>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Tipo de mantenimiento</label>
Â  Â  Â  Â  <div class="row" style="margin-top:6px">
Â  Â  Â  Â  Â  <label class="chip"><input type="radio" name="tipo_mantenimiento" value="Preventivo" required> Preventivo</label>
Â  Â  Â  Â  Â  <label class="chip"><input type="radio" name="tipo_mantenimiento" value="Correctivo"> Correctivo</label>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Equipos</label>
Â  Â  Â  Â  <div id="teams"></div>
Â  Â  Â  Â  <div class="actions" style="margin-top:6px">
Â  Â  Â  Â  Â  <button type="button" id="addTeam" class="btn-secondary">â• Agregar equipo</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small" style="margin-top:8px">Agrega uno o varios equipos. Para cada equipo selecciona el tipo (Condensadora o Evaporadora/Manejadora).</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Observaciones / Recomendaciones</label>
Â  Â  Â  Â  <textarea name="observaciones" rows="4" placeholder="DescripciÃ³n breve de hallazgos o recomendaciones..."></textarea>
Â  Â  Â  Â  <div class="muted" style="margin-top:8px">NO usar caracteres especiales ni saltos de lÃ­nea largos.</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Correo del cliente (para enviar PDF)</label>
Â  Â  Â  Â  <input type="email" name="correo_cliente" placeholder="cliente@empresa.com" required>

Â  Â  Â  Â  <label style="margin-top:10px">Nombre del tÃ©cnico responsable</label>
Â  Â  Â  Â  <input type="text" name="nombre_tecnico" required>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label style="margin-top:10px">Nombre y cargo de quien recibe/aprueba (Cliente)</label>
Â  Â  Â  Â  <input type="text" name="nombre_cliente" required>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Firma del tÃ©cnico (dibujar con dedo o mouse)</label>
Â  Â  Â  Â  <canvas id="firmaTecnicoCanvas"></canvas>
Â  Â  Â  Â  <div class="actions" style="margin-top:8px">
Â  Â  Â  Â  Â  <button type="button" id="clearSigTec" class="btn-secondary">Limpiar firma</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <label>Firma de aprobaciÃ³n del cliente (dibujar con dedo o mouse)</label>
Â  Â  Â  Â  <canvas id="firmaClienteCanvas"></canvas>
Â  Â  Â  Â  <div class="actions" style="margin-top:8px">
Â  Â  Â  Â  Â  <button type="button" id="clearSigCli" class="btn-secondary">Limpiar firma</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" style="margin-top:8px">Ambas firmas se guardan en Drive y se adjuntan al PDF.</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button type="submit" class="btn-primary">Enviar reporte</button>
Â  Â  Â  </div>
Â  Â  </form>
Â  </div>

<script>
// ============================================================
// LÃ“GICA DEL FORMULARIO Y ENVÃO
// ============================================================

// Utilidad para crear elementos
function createEl(tag, attrs={}, children=[]) {
Â  const el = document.createElement(tag);
Â  for (const k in attrs) {
Â  Â  if (k === 'class') el.className = attrs[k];
Â  Â  else if (k === 'text') el.textContent = attrs[k];
Â  Â  else el.setAttribute(k, attrs[k]);
Â  }
Â  children.forEach(c => el.appendChild(c));
Â  return el;
}

let teamCount = 0;
const maxTeams = 10;
const teamsDiv = document.getElementById('teams');
document.getElementById('addTeam').addEventListener('click', ()=> addTeam());

function addTeam() {
Â  if (teamCount >= maxTeams) { alert('MÃ¡ximo de equipos alcanzado ('+maxTeams+')'); return; }
Â  teamCount++;
Â  const id = teamCount;
Â  const card = createEl('div', {class:'team', id:'team-'+id});
Â  const header = createEl('div', {class:'row'});
Â  const col1 = createEl('div', {class:'col'});
Â  const col2 = createEl('div', {class:'col'});
Â  col1.appendChild(createEl('label',{text:'Tipo de equipo'}));
Â  const tipo = createEl('select',{name:'tipo_equipo_'+id});
Â  tipo.innerHTML = '<option value="Condensadora">Condensadora</option><option value="Evaporadora/Manejadora">Evaporadora/Manejadora</option>';
Â  col1.appendChild(tipo);
Â  col2.appendChild(createEl('label',{text:'UbicaciÃ³n'}));
Â  col2.appendChild(createEl('input',{type:'text', name:'ubicacion_'+id, placeholder:'Sala/Local/Altura'}));
Â  header.appendChild(col1); header.appendChild(col2);
Â  card.appendChild(header);

Â  const tasksDiv = createEl('div',{class:'tasks', id:'tasks_'+id});
Â  card.appendChild(tasksDiv);
Â  const measDiv = createEl('div',{class:'measure', id:'meas_'+id});
Â  card.appendChild(measDiv);

Â  const rem = createEl('div',{class:'actions'});
Â  const remBtn = createEl('button',{type:'button',class:'btn-secondary', text:'ğŸ—‘ï¸ Eliminar equipo'});
Â  remBtn.addEventListener('click', ()=> { card.remove(); teamCount--; });
Â  rem.appendChild(remBtn);
Â  card.appendChild(rem);

Â  teamsDiv.appendChild(card);

Â  function populateForType(value) {
Â  Â  tasksDiv.innerHTML = ''; measDiv.innerHTML = '';
Â  Â  if (value === 'Condensadora') {
Â  Â  Â  tasksDiv.appendChild(createEl('label',{text:'Tareas realizadas (Condensadora)'}));
Â  Â  Â  const items = [
Â  Â  Â  Â  "Lavado serpentÃ­n con producto quÃ­mico",
Â  Â  Â  Â  "Lavado de tapas y bandejas",
Â  Â  Â  Â  "Limpieza tablero, compresor, ventiladores",
Â  Â  Â  Â  "RevisiÃ³n, vibraciones, bases, soportes",
Â  Â  Â  Â  "CorrecciÃ³n fugas aceite, gas refrigerante",
Â  Â  Â  Â  "RevisiÃ³n y/o cambio de rodamientos",
Â  Â  Â  Â  "RevisiÃ³n y/o cambio de chumaceras",
Â  Â  Â  Â  "RevisiÃ³n de balanceo y lubricaciÃ³n de ventilador",
Â  Â  Â  Â  "RevisiÃ³n y/o cambio de aislamiento tÃ©rmico",
Â  Â  Â  Â  "Mantenimiento elÃ©ctrico, cableado, bornes",
Â  Â  Â  Â  "Mantenimiento y calibraciÃ³n de controles",
Â  Â  Â  Â  "Mantenimiento al chasis",
Â  Â  Â  Â  "Pintura anticorrosivo, tornillerÃ­a",
Â  Â  Â  Â  "Ajuste carga de gas, puesta a punto",
Â  Â  Â  Â  "RevisiÃ³n tuberÃ­as refrigeraciÃ³n. aislamiento"
Â  Â  Â  ];
Â  Â  Â  items.forEach((it)=>{
Â  Â  Â  Â  const lbl = createEl('label',{class:'chip'});
Â  Â  Â  Â  const cb = createEl('input',{type:'checkbox', name:'task_'+id, value:it}); 
Â  Â  Â  Â  lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' '+it));
Â  Â  Â  Â  tasksDiv.appendChild(lbl);
Â  Â  Â  });

Â  Â  Â  measDiv.appendChild(createEl('label',{text:'Mediciones (Condensadora)'}));
Â  Â  Â  const measures = [
Â  Â  Â  Â  "Toma presiÃ³n gas baja",
Â  Â  Â  Â  "Toma presiÃ³n gas alta",
Â  Â  Â  Â  "Consumo amperios compresor L1",
Â  Â  Â  Â  "Consumo amperios compresor L2",
Â  Â  Â  Â  "Consumo amperios compresor L3",
Â  Â  Â  Â  "Consumo Placa Compresor (RLA)",
Â  Â  Â  Â  "L1L2 Voltaje de suministro",
Â  Â  Â  Â  "L2L3 Voltaje de suministro",
Â  Â  Â  Â  "L1L3 Voltaje de suministro",
Â  Â  Â  Â  "Consumo elÃ©ctrico motor ventilador",
Â  Â  Â  Â  "Amperaje Placa motor ventilador (FLA)"
Â  Â  Â  ];
Â  Â  Â  measures.forEach(m=>{
Â  Â  Â  Â  const la = createEl('label',{text:m});
Â  Â  Â  Â  const inp = createEl('input',{type:'text', name:'meas_'+id+'_'+m, placeholder:''}); 
Â  Â  Â  Â  measDiv.appendChild(la); measDiv.appendChild(inp);
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  tasksDiv.appendChild(createEl('label',{text:'Tareas realizadas (Evaporadora/Manejadora)'}));
Â  Â  Â  const items = [
Â  Â  Â  Â  "Lavado de serpentines",
Â  Â  Â  Â  "Lavado de filtros",
Â  Â  Â  Â  "DesincrustaciÃ³n con producto quÃ­mico",
Â  Â  Â  Â  "ReparaciÃ³n de ductos",
Â  Â  Â  Â  "Limpieza de rejillas",
Â  Â  Â  Â  "RevisiÃ³n de transmisiones alineaciÃ³n",
Â  Â  Â  Â  "RevisiÃ³n y/o balanceo de ventiladores",
Â  Â  Â  Â  "RevisiÃ³n y/o cambio de rodamientos",
Â  Â  Â  Â  "LubricaciÃ³n de motores",
Â  Â  Â  Â  "Limpieza de drenajes y bandejas"
Â  Â  Â  ];
Â  Â  Â  items.forEach(it=>{
Â  Â  Â  Â  const lbl = createEl('label',{class:'chip'});
Â  Â  Â  Â  const cb = createEl('input',{type:'checkbox', name:'task_'+id, value:it});
Â  Â  Â  Â  lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' '+it));
Â  Â  Â  Â  tasksDiv.appendChild(lbl);
Â  Â  Â  });

Â  Â  Â  measDiv.appendChild(createEl('label',{text:'Mediciones (Evaporadora/Manejadora)'}));
Â  Â  Â  const measures = [
Â  Â  Â  Â  "Temperatura sala / Set Point",
Â  Â  Â  Â  "Consumo elÃ©ctrico motor ventilador",
Â  Â  Â  Â  "Amperaje Placa motor ventilador (FLA)",
Â  Â  Â  Â  "RevisiÃ³n de glicerina",
Â  Â  Â  Â  "Es necesario el cambio de glicerina en las neveras"
Â  Â  Â  ];
Â  Â  Â  measures.forEach(m=>{
Â  Â  Â  Â  const la = createEl('label',{text:m});
Â  Â  Â  Â  if (m.includes("RevisiÃ³n") || m.includes("Es necesario")) {
Â  Â  Â  Â  Â  const sel = createEl('select',{name:'meas_'+id+'_'+m}); 
Â  Â  Â  Â  Â  sel.innerHTML = '<option value="SÃ­">SÃ­</option><option value="No">No</option>';
Â  Â  Â  Â  Â  measDiv.appendChild(la); measDiv.appendChild(sel);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const inp = createEl('input',{type:'text', name:'meas_'+id+'_'+m}); 
Â  Â  Â  Â  Â  measDiv.appendChild(la); measDiv.appendChild(inp);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  }

Â  populateForType('Condensadora');
Â  tipo.addEventListener('change', ()=> populateForType(tipo.value));
}

// ============================================================
// LÃ“GICA DE FIRMAS (Canvas)
// ============================================================

// FunciÃ³n de configuraciÃ³n de Canvas (Para no repetir cÃ³digo)
function setupCanvas(canvas, ctx, clearButton) {
Â  let drawing = false;
Â  let last = {x:0,y:0};

Â  function resizeCanvas() {
Â  Â  const ratio = window.devicePixelRatio || 1;
Â  Â  const w = canvas.clientWidth;
Â  Â  const h = canvas.clientHeight;
Â  Â  canvas.width = w * ratio;
Â  Â  canvas.height = h * ratio;
Â  Â  ctx.setTransform(ratio,0,0,ratio,0,0);
Â  Â  ctx.lineWidth = 2;
Â  Â  ctx.lineCap = 'round';
Â  Â  ctx.strokeStyle = '#0b1226';
Â  Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  }
Â  resizeCanvas();
Â  window.addEventListener('resize', resizeCanvas);

Â  function getPos(e){
Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  if (e.touches) { e = e.touches[0]; }
Â  Â  return {x: e.clientX - rect.left, y: e.clientY - rect.top};
Â  }
Â Â 
Â  canvas.addEventListener('pointerdown', e=>{ drawing=true; last=getPos(e); });
Â  canvas.addEventListener('pointerup', e=>{ drawing=false; ctx.beginPath(); });
Â  canvas.addEventListener('pointermove', e=>{
Â  Â  if (!drawing) return;
Â  Â  const p = getPos(e);
Â  Â  ctx.beginPath();
Â  Â  ctx.moveTo(last.x,last.y);
Â  Â  ctx.lineTo(p.x,p.y);
Â  Â  ctx.stroke();
Â  Â  last = p;
Â  });
Â Â 
Â  clearButton.addEventListener('click', ()=>{
Â  Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  Â  resizeCanvas();
Â  });
}

// Firma del TÃ©cnico
const canvasTec = document.getElementById('firmaTecnicoCanvas');
const ctxTec = canvasTec.getContext('2d');
setupCanvas(canvasTec, ctxTec, document.getElementById('clearSigTec'));

// Firma del Cliente
const canvasCli = document.getElementById('firmaClienteCanvas');
const ctxCli = canvasCli.getContext('2d');
setupCanvas(canvasCli, ctxCli, document.getElementById('clearSigCli'));

// EnvÃ­o del formulario - AHORA COMO FORM-DATA (Simple Request) para evitar CORS
document.getElementById('form').addEventListener('submit', async (e)=>{
Â  e.preventDefault();
Â  const form = e.target;
Â  const fd = new FormData(form);
Â Â 
Â  // Usamos URLSearchParams para construir el body como 'x-www-form-urlencoded'
Â  const params = new URLSearchParams();
Â Â 
Â  // 1. Procesar campos normales (simples)
Â  for (const [key, value] of fd.entries()) {
Â  Â  // Excluir campos que se procesan aparte (arrays y firmas)
Â  Â  if (key === 'epp' || key.startsWith('task_') || key.startsWith('meas_')) {
Â  Â  Â  continue; 
Â  Â  }
Â  Â  params.append(key, value);
Â  }
Â Â 
Â  // 2. Procesar firmas (Base64)
Â  params.append('firma_tecnico', canvasTec.toDataURL('image/png'));
Â  params.append('firma_cliente', canvasCli.toDataURL('image/png'));
Â Â 
Â  // 3. Procesar EPP (permite mÃºltiples valores)
Â  fd.getAll('epp').forEach(v => params.append('epp', v));
Â Â 
Â  // 4. Procesar la estructura compleja de EQUIPOS (se serializa a JSON string)
Â  const equipos = [];
Â  for (let i=1;i<=maxTeams;i++){
Â  Â  const el = document.getElementById('team-'+i);
Â  Â  if (!el) continue;
Â  Â  
Â  Â  const tipo = el.querySelector('select').value;
Â  Â  const ubic = el.querySelector('input[type="text"]').value;
Â  Â  const tasks = [];
Â  Â  el.querySelectorAll('input[type="checkbox"][name="task_'+i+'"]').forEach(cb=>{ if(cb.checked) tasks.push(cb.value); });
Â  Â  const meas = {};
Â  Â  el.querySelectorAll('[name^="meas_'+i+'_"]').forEach(inp=>{
Â  Â  Â  const val = inp.tagName === 'SELECT' ? inp.value : inp.value || ''; 
Â  Â  Â  meas[inp.name.replace('meas_'+i+'_','')] = val;
Â  Â  });
Â  Â  
Â  Â  equipos.push({tipo, ubicacion:ubic, tareas:tasks, mediciones:meas});
Â  }
Â  
Â  // CLAVE: AÃ±adir el objeto EQUIPOS serializado a los parÃ¡metros
Â  params.append('equipos', JSON.stringify(equipos));
Â Â 
Â  // âš ï¸ URL ACTUALIZADA CON TU NUEVA IMPLEMENTACIÃ“N
Â  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyngHIv7d3pHuAn1TRZ24kPaV66Vi6ArrnDH55sMMCr1CsJ15QZoSDQ3k1810pbkgp8/exec'; 

Â  try {
Â  Â  const resp = await fetch(WEB_APP_URL, {
Â  Â  Â  method:'POST',
Â  Â  Â  // CLAVE: Enviamos como form-urlencoded para evitar la peticiÃ³n OPTIONS/CORS
Â  Â  Â  headers: {'Content-Type':'application/x-www-form-urlencoded'}, 
Â  Â  Â  body: params.toString() // Enviamos los parÃ¡metros serializados
Â  Â  });
Â  Â   
Â  Â  // Manejo de la respuesta del Apps Script (ESPERAMOS JSON)
Â  Â  const result = await resp.json(); 
Â  Â  
Â  Â  if (result.status === 'ok') {
Â  Â  Â  Â  alert('Reporte enviado correctamente. ' + result.result);
Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  ctxTec.clearRect(0,0,canvasTec.width,canvasTec.height);
Â  Â  Â  Â  ctxCli.clearRect(0,0,canvasCli.width,canvasCli.height);
Â  Â  } else {
Â  Â  Â  Â  throw new Error(result.error || 'Error desconocido');
Â  Â  }
Â  } catch (err) {
Â  Â  // Si ocurre el error "Unexpected token", el problema es que el script devolviÃ³ HTML y no JSON.
Â  Â  // Esto significa que la URL de ejecuciÃ³n aÃºn no es vÃ¡lida, la implementaciÃ³n fallÃ³, o Google la bloquea.
Â  Â  alert('Error al enviar: ' + err.message + '. Posibles causas: URL incorrecta, implementaciÃ³n fallida, o cachÃ© de Google.');
Â  Â  console.error(err);
Â  }
});
</script>
</body>
</html>
